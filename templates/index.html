<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lipsync App</title>
    <style>
        body {
            font-family: sans-serif;
        }
        #container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 500px;
            margin: 0 auto;
        }
        input[type="file"], button {
            margin: 10px;
            padding: 8px 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Lipsync App</h1>

        <input type="file" id="imageInput" accept="image/*">
        <label for="audioInput">Choose audio file:</label>
        <input type="file" id="audioInput" accept="audio/*">

        <p>OR</p>

        <button id="recordButton">Record Audio from Webcam</button>
        <div id="recordingStatus"></div>

        <button id="startLipsync">Start Lipsync</button>
        <div id="status"></div>
        <div id="result"></div>
    </div>

    <script>
        const imageInput = document.getElementById('imageInput');
        const audioInput = document.getElementById('audioInput');
        const recordButton = document.getElementById('recordButton');
        const recordingStatus = document.getElementById('recordingStatus');
        const startLipsyncButton = document.getElementById('startLipsync');
        const statusDiv = document.getElementById('status');
        const resultDiv = document.getElementById('result');

        let mediaRecorder;
        let recordedChunks = [];

        recordButton.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = (event) => {
                    recordedChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(recordedChunks, { type: 'audio/wav' });
                    recordedChunks = [];

                    const audioURL = URL.createObjectURL(audioBlob);
                    const audioLink = document.createElement('a');
                    audioLink.href = audioURL;
                    audioLink.download = 'recorded_audio.wav';
                    audioLink.innerText = 'Download recorded audio';
                    recordingStatus.appendChild(audioLink); 
                    
                    // You can now use the audioBlob to send to the server
                    // Example:
                    // const formData = new FormData();
                    // formData.append('webcam_audio', audioBlob, 'recorded_audio.wav');
                    // // ... send formData to server 
                };

                mediaRecorder.start();
                recordingStatus.innerText = 'Recording...';
            } catch (error) {
                console.error('Error accessing microphone:', error);
                recordingStatus.innerText = 'Error accessing microphone';
            }
        });

        startLipsyncButton.addEventListener('click', async () => {
            const formData = new FormData();

            if (imageInput.files[0]) {
                formData.append('image', imageInput.files[0]);
            }

            if (audioInput.files[0]) {
                formData.append('audio', audioInput.files[0]);
            } 

            // Add webcam audio if available 
            // (You'll need to handle how to send the blob to the server)
            // Example: if (recordedChunks.length > 0) { ... }

            try {
                const response = await fetch('/lipsync/', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                const jobId = data.job_id;
                statusDiv.innerText = 'Lipsync process started. Job ID: ' + jobId;

                // Poll for status updates
                const intervalId = setInterval(async () => {
                    const statusResponse = await fetch('/status/' + jobId);
                    const statusData = await statusResponse.json();
                    statusDiv.innerText = 'Status: ' + statusData.status;

                    if (statusData.status === 'Completed') {
                        clearInterval(intervalId);
                        const resultLink = document.createElement('a');
                        resultLink.href = '/result/' + jobId;
                        resultLink.innerText = 'Download Result';
                        resultDiv.appendChild(resultLink);
                    }
                }, 2000); 

            } catch (error) {
                console.error('Error starting lipsync:', error);
                statusDiv.innerText = 'Error starting lipsync';
            }
        });
    </script>
</body>
</html>